"use strict";function _classCallCheck(n,t){if(!(n instanceof t))throw new TypeError("Cannot call a class as a function");}var _createClass=function(){function n(n,t){for(var i,r=0;r<t.length;r++)i=t[r],i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(n,i.key,i)}return function(t,i,r){return i&&n(t.prototype,i),r&&n(t,r),t}}(),MarkDownEditor;marked.setOptions({renderer:new marked.Renderer,highlight:function(n){if(window.hljs)return hljs.highlightAuto(n).value},pedantic:!1,gfm:!0,tables:!0,breaks:!1,sanitize:!0,smartLists:!0,smartypants:!1,xhtml:!1});MarkDownEditor=function(){function n(t){_classCallCheck(this,n);this.selector=t;this._height=t.css("height");this._uploadUrl=t.attr("action");this.preview=$(".mozmd-preview",t);this.source=$(".mozmd-source",t);this.actions=$(".mozmd-toolbar a",t);this._value=$(".mozmd-source-value",t);this._html=$(".mozmd-html-value",t);this.init()}return _createClass(n,[{key:"update",value:function(){var t=this.source.text(),n;this._value.val(t);n=marked.parse(t);this.preview.html(n);this._html.val(n);this.selector.trigger("mozmd.updated")}},{key:"paste",value:function(n){var f=this,t,i,r,u;if(!this._uploadUrl)return!0;if(this.saveSelection(),t=n.clipboardData||n.originalEvent.clipboardData,t&&t.items)for(i=0;i<t.items.length;i++)if(r=t.items[i],r.kind=="file"&&r.type.indexOf("image")!=-1)return u=r.getAsFile(),this.upload(u,function(n){f.replaceSelection(function(t){var i="";return t?i=' "'+t+'"':t="","!["+i+"]("+n.url+")"})}),!1;return!0}},{key:"saveSelection",value:function(){var u,t,i,f,r,n;if(window.getSelection&&document.createRange){if(u=window.getSelection(),!u.rangeCount){this._selection={start:0,end:0};return}t=u.getRangeAt(0);i=t.cloneRange();i.selectNodeContents(this.source[0]);i.setEnd(t.startContainer,t.startOffset);n=i.toString().length;this._selection={start:n,end:n+t.toString().length}}else document.selection&&document.body.createTextRange&&(f=document.selection.createRange(),r=document.body.createTextRange(),r.moveToElementText(this.source[0]),r.setEndPoint("EndToStart",f),n=r.text.length,this._selection={start:n,end:n+f.text.length})}},{key:"restoreSelection",value:function(){var n=this._selection,t,r,f,o,s,u;if(window.getSelection&&document.createRange){t=0;r=document.createRange();r.setStart(this.source[0],0);r.collapse(!0);for(var h=[this.source[0]],i,e=!1,c=!1;!c&&(i=h.pop());)if(i.nodeType==3)f=t+i.length,!e&&n.start>=t&&n.start<=f&&(r.setStart(i,n.start-t),e=!0),e&&n.end>=t&&n.end<=f&&(r.setEnd(i,n.end-t),c=!0),t=f;else for(o=i.childNodes.length;o--;)h.push(i.childNodes[o]);s=window.getSelection();s.removeAllRanges();s.addRange(r)}else document.selection&&document.body.createTextRange&&(u=document.body.createTextRange(),u.moveToElementText(this.source[0]),u.collapse(!0),u.moveEnd("character",n.end),u.moveStart("character",n.start),u.select())}},{key:"replaceSelection",value:function(n,t){var r,i,u,f,e;this.restoreSelection();window.getSelection?(r=window.getSelection(),typeof n=="function"?(f=r.toString(),n=n(f),u=f.length):u=n.length,r.getRangeAt&&r.rangeCount&&(i=r.getRangeAt(0),i.deleteContents(),e=document.createTextNode(n),i.insertNode(e),r.removeAllRanges(),i=i.cloneRange(),i.selectNode(e),i.collapse(!1),r.addRange(i))):document.selection&&document.selection.createRange&&(i=document.selection.createRange(),typeof n=="function"?(n=n(i.text),u=i.text):u=n.length,i.pasteHTML(n),i.select());typeof t!="undefined"&&(this._selection=this._selection?{start:this._selection.start+t,end:this._selection.start+t+u}:{start:0,end:u},this.restoreSelection());this.update()}},{key:"toggleActions",value:function(){this.source.is(":visible")?this.actions.filter(".disabled").removeClass("disabled"):this.actions.each(function(){this.className.startsWith("mozmd-syntax-")&&$(this).addClass("disabled")})}},{key:"init",value:function(){var n=this;this.source.on("input",function(){return n.update()}).on("paste",function(t){return n.paste(t)}).on("keydown",function(t){if(t.keyCode==9)return n.saveSelection(),t.shiftKey?n.replaceSelection(function(n){if(!n)return"";var t=[];return n.split("\n").forEach(function(n){n.startsWith("\t")?t.push(n.substr(1)):t.push(n)}),t.join("\n")}):n.replaceSelection(function(n){return n?"\t"+n.split("\n").join("\n\t"):"\t"}),!1});this.actions.exec(function(t){return t.off("mousedown").on("mousedown",function(){var i,r,u;n.saveSelection();i=t.attr("class");switch(i){case"mozmd-fullscreen":$(document.body).addClass("fullscreen");n.selector.addClass("fullscreen-container").css("height","100%");t.attr("class","mozmd-exitfull").attr("title",resources.fullscreen.quit).find("i").attr("class","bi-window-stack");break;case"mozmd-exitfull":$(document.body).removeClass("fullscreen");n.selector.removeClass("fullscreen-container").css("height",n._height);t.attr("class","mozmd-fullscreen").attr("title",resources.fullscreen.show).find("i").attr("class","bi-window-fullscreen");break;case"mozmd-mode-preview":n.source.hide();n.preview.show();t.attr("class","mozmd-mode-source").attr("title",resources.markdown.source).find("i").attr("class","bi-keyboard");n.toggleActions();break;case"mozmd-mode-source":n.source.show();n.preview.hide();t.attr("class","mozmd-mode-preview").attr("title",resources.markdown.preview).find("i").attr("class","bi-eye");n.toggleActions();break;case"mozmd-syntax-bold":n.replaceSelection(function(n){return"**"+n.trim()+"**"},2);break;case"mozmd-syntax-italic":n.replaceSelection(function(n){return"_"+n.trim()+"_"},1);break;case"mozmd-syntax-header":n.replaceSelection(function(n){return(n=n.trim(),n[0]=="#")?"#"+n:"# "+n},1);break;case"mozmd-syntax-code":n.replaceSelection(function(n){return n?n.indexOf("\n")==-1?n.startsWith("`")?n:"`"+n+"`":n.startsWith("```")?n:"```\n"+n.trim()+"\n```\n":"```\n\n```\n"});break;case"mozmd-syntax-ul":n.replaceSelection(function(n){if(!n)return"* ";var t=[];return n.split("\n").forEach(function(n){n.startsWith("1. ")?t.push("*"+n.substr(2)):n.startsWith("* ")?t.push(n):t.push("* "+n)}),t.join("\n")});break;case"mozmd-syntax-ol":n.replaceSelection(function(n){if(!n)return"1. ";var t=[];return n.split("\n").forEach(function(n){n.startsWith("* ")?t.push("1. "+n.substr(1)):n.startsWith("1. ")?t.push(n):t.push("1. "+n)}),t.join("\n")});break;case"mozmd-syntax-link":r=window.prompt(resources.markdown.link,"http://");r&&n.replaceSelection(function(n){return n||(n=r),"["+n+"]("+r+")"},1);break;case"mozmd-syntax-quote":n.replaceSelection(function(n){return"> "+n},1);break;case"mozmd-syntax-image":if(!n._uploadUrl){u=window.prompt(resources.markdown.image,"http://");u&&n.replaceSelection(function(n){var t="";return n&&(t=' "'+n+'"'),"!["+t+"]("+u+")"},2);break}n.showDialog(i,'<div class="mb-2">\n            <label>'+resources.markdown.image+'：<\/label>\n            <div class="input-group-append">\n                <input class="form-control form-control-sm" type="text" name="image-url"/>\n                <input type="file" class="hide"/>\n                <button type="button" onclick="$(this).parent().find(\'input[type=file]\').click();" title="'+resources.markdown.upload+'"><i class="bi-upload"><\/i><\/button>\n            <\/div>\n            <\/div><div class="mb-1">\n            <label>'+resources.markdown.title+'：<\/label>\n            <input class="form-control form-control-sm" type="text" name="image-title"/>\n        <\/div>',function(t){var r=t.find("input[name=image-url]").val().trim(),i;r&&(i=t.find("input[name=image-title]").val().trim(),n.replaceSelection(function(n){return i&&(n=n||i,i=' "'+i+'"'),"!["+i+"]("+r+")"}))}).find("input[type=file]").on("change",function(t){var i=$(t.target);t.target.files.length!=0&&n.upload(t.target.files[0],function(n){i.parent().find("input[name=image-url]").val(n.url)})})}return n.selector.trigger(i.replace(/-+/ig,".")),!1})});this.update()}},{key:"upload",value:function(n,t){var r=new FormData,i,u;if(r.append("file",n),i=this.selector.json(),i)for(u in i)r.append(u,i[u]);$ajax(this._uploadUrl,r,t)}},{key:"showDialog",value:function(n,t,i,r){var u=$(document.body).dset("gt-"+n,function(){return $('<div class="modal fade" data-bs-backdrop="static"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-body"><\/div><div class="modal-footer"><button type="button" class="btn btn-primary"> '+resources.modal.confirm+" <\/button><\/div><\/div><\/div><\/div>").appendTo(document.body)}),f;if(u.find(".modal-body").html(t),typeof i=="function"&&(r=i,i=undefined),i&&u.find(".modal-footer").html(i),f=u.find("button.btn-primary").off("click"),r)f.removeAttr("data-bs-dismiss").on("click",function(){typeof r=="function"?(u.modal("hide"),r(u)):location.href=typeof r=="object"?r.url||location.href:location.href});else f.attr("data-bs-dismiss","modal").off("click");return onrender(u),u.modal("show"),u}},{key:"value",get:function(){return this._value.val()},set:function(n){this.source.text(n);this.update()}},{key:"html",get:function(){return this._html.val()}}]),n}();onrender(function(n){$(".mozmd-editor",n).each(function(){var n=$(this);n.data("mozmd-editor",new MarkDownEditor(n))})});